#!/bin/bash
# Usage: S3KEY=abcde S3SECRET=1234 BUCKET=mybucket configure

function showusage {
cat <<EOF
NAME
   configure - configure simplesecrets for secret upload

SYNOPSIS
   S3KEY=abcde S3SECRET=1234 BUCKET=mybucket configure
DESCRIPTION
   Installs the S3 key, secret and bucket passed via environment variables into a volume container.
   Required for simplesecrets to be able to upload files.
RETURN VALUE
   0   - success
   1   - error
   3   - no change

EOF
   exit 1
}

if [ -z "${S3KEY}" ]; then echo "Missing S3KEY." ; showusage ; fi
if [ -z "${S3SECRET}" ]; then echo "Missing S3SECRET." ; showusage ; fi
if [ -z "${BUCKET}" ]; then echo "Missing BUCKET." ; showusage ; fi

cat <<EOF >/tmp/s3
# S3 configuration
S3KEY=${S3KEY}
S3SECRET=${S3SECRET}
BUCKET=${BUCKET}
EOF

diff /config/s3 /tmp/s3 >/dev/null 2>&1
if [ $? -eq 0 ]; then
   rm /tmp/s3
   echo "S3 configuration unchanged."
   exit 3
fi

mv /tmp/s3 /config/upload.sh
echo "S3 configuration updated."
exit 0
